<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>auto-investor</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="sticky-header" id="sticky-header">
    <div class="header-row">
        <h1>üìà auto-investor <span style="font-size:0.55em; color:#8b949e; font-weight:400;">v{{ version }}</span></h1>
        <span id="next-analysis" style="font-size:0.85rem; color:#8b949e; font-weight:400;"></span>
        <button class="btn-trade" id="force-cycle-btn" onclick="forceCycle()">‚ö° Run Analysis</button>
    </div>
    <p class="timestamp" id="live-status" style="margin-bottom: 12px;">Live updates via WebSocket ‚Ä¢ {% if snapshot %}Last cycle: {{ snapshot["timestamp"][:19].replace("T", " ") }}{% else %}No data yet{% endif %}</p>

    <div class="grid" id="stats-grid">
        <div class="card">
            <div class="label">Equity</div>
            <div class="value" id="live-equity">
                {% if snapshot %}
                  ${{ "{:,.2f}".format(snapshot["equity"]) }}
                {% else %}
                  --
                {% endif %}
            </div>
        </div>
        <div class="card">
            <div class="label">Cash</div>
            <div class="value" id="live-cash">
                {% if snapshot %}
                    ${{ "{:,.2f}".format(snapshot["cash"]) }}
                {% else %}
                    --
                {% endif %}
            </div>
        </div>
        <div class="card">
            <div class="label">Buying Power</div>
            <div class="value" id="live-buying-power">
                {% if snapshot %}
                    ${{ "{:,.2f}".format(snapshot["buying_power"]) }}
                {% else %}
                    --
                {% endif %}
            </div>
        </div>
        <div class="card">
            <div class="label">Daily P&amp;L</div>
            <div
                class="value {{ 'positive' if snapshot and snapshot['daily_pl'] >= 0 else 'negative' if snapshot else '' }}"
                id="live-daily-pl"
            >
                {% if snapshot %}
                    ${{ "{:+,.2f}".format(snapshot["daily_pl"]) }}
                {% else %}
                    --
                {% endif %}
            </div>
        </div>
        <div class="card">
            <div class="label">Equity P&amp;L</div>
            <div
                class="value {{ 'positive' if live_pl and live_pl.equity_pl >= 0 else 'negative' if live_pl else '' }}"
                id="live-equity-pl"
            >
                {% if live_pl %}${{ "{:+,.2f}".format(live_pl.equity_pl) }}{% else %}--{% endif %}
            </div>
        </div>
        <div class="card">
            <div class="label">Crypto P&amp;L</div>
            <div
                class="value {{ 'positive' if live_pl and live_pl.crypto_pl >= 0 else 'negative' if live_pl else '' }}"
                id="live-crypto-pl"
            >
                {% if live_pl %}${{ "{:+,.2f}".format(live_pl.crypto_pl) }}{% else %}--{% endif %}
            </div>
        </div>
    </div>
    </div>

    <div class="chart-container" id="equity-chart-wrapper" {% if equity_history|length <= 1 %}style="display:none"{% endif %}>
        <canvas id="equityChart"></canvas>
    </div>

    <h2>Equity Positions</h2>
    <table class="positions-table">
        <thead>
            <tr>
                <th>Symbol</th>
                <th>Qty</th>
                <th>Avg Entry</th>
                <th>Current</th>
                <th>Market Value</th>
                <th>P&L</th>
                <th>P&L %</th>
            </tr>
        </thead>
        <tbody id="equity-positions-body">
            {% for p in equity_positions %}
            <tr>
                <td><strong class="symbol-link" onclick="event.stopPropagation();showChart('{{ p.symbol }}')">{{ p.symbol }}</strong></td>
                <td>{{ "{:,.4f}".format(p.quantity|float).rstrip('0').rstrip('.') }}</td>
                <td>${{ "{:,.2f}".format(p.avg_entry_price) }}</td>
                <td>${{ "{:,.2f}".format(p.current_price) }}</td>
                <td>${{ "{:,.2f}".format(p.market_value) }}</td>
                <td class="{{ 'positive' if p.unrealized_pl >= 0 else 'negative' }}">
                    ${{ "{:+,.2f}".format(p.unrealized_pl) }}
                </td>
                <td class="{{ 'positive' if p.unrealized_pl_pct >= 0 else 'negative' }}">
                    {{ "{:+.1f}".format(p.unrealized_pl_pct) }}%
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2>Crypto Positions</h2>
    <table class="positions-table">
        <thead>
            <tr>
                <th>Symbol</th>
                <th>Qty</th>
                <th>Avg Entry</th>
                <th>Current</th>
                <th>Market Value</th>
                <th>P&L</th>
                <th>P&L %</th>
            </tr>
        </thead>
        <tbody id="crypto-positions-body">
            {% for p in crypto_positions %}
            <tr>
                <td><strong class="symbol-link" onclick="event.stopPropagation();showChart('{{ p.symbol }}')">{{ p.symbol }}</strong></td>
                <td>{{ "{:,.4f}".format(p.quantity|float).rstrip('0').rstrip('.') }}</td>
                <td>${{ "{:,.2f}".format(p.avg_entry_price) }}</td>
                <td>${{ "{:,.2f}".format(p.current_price) }}</td>
                <td>${{ "{:,.2f}".format(p.market_value) }}</td>
                <td class="{{ 'positive' if p.unrealized_pl >= 0 else 'negative' }}">
                    ${{ "{:+,.2f}".format(p.unrealized_pl) }}
                </td>
                <td class="{{ 'positive' if p.unrealized_pl_pct >= 0 else 'negative' }}">
                    {{ "{:+.1f}".format(p.unrealized_pl_pct) }}%
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2 style="display:flex; align-items:center; justify-content:space-between;">
        Recent Decisions
        <span style="font-size:0.75rem; font-weight:400; color:#8b949e; display:flex; align-items:center; gap:10px;">
            <input id="dec-symbol-filter" type="text" placeholder="Filter symbol‚Ä¶" autocomplete="off"
                   style="background:#161b22;color:#c9d1d9;border:1px solid #30363d;border-radius:4px;padding:2px 8px;font-size:0.75rem;width:110px;">
            Show
            <select id="dec-per-page" autocomplete="off" style="background:#161b22;color:#c9d1d9;border:1px solid #30363d;border-radius:4px;padding:2px 6px;font-size:0.75rem;">
                {% for n in [5, 10, 25, 50] %}
                <option value="{{ n }}" {{ 'selected' if per_page == n else '' }}>{{ n }}</option>
                {% endfor %}
            </select>
            per page
        </span>
    </h2>
    <div id="decisions-container">
    {% if decisions %}
    <table>
        <thead>
            <tr>
                <th>Time</th>
                <th>Symbol</th>
                <th>Action</th>
                <th>Confidence</th>
                <th>Qty</th>
                <th>Reasoning</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="decisions-body">
            {% for d in decisions %}
            <tr class="clickable" onclick="showDecision({{ d['id'] }})">
                <td class="timestamp">{{ d["timestamp"][:16].replace("T", " ") }}</td>
                <td><strong class="symbol-link" onclick="event.stopPropagation();showChart('{{ d.symbol }}')">{{ d["symbol"] }}</strong></td>
                <td>
                    <span class="badge badge-{{ d['action'] }}">{{ d["action"] }}</span>
                </td>
                <td>{{ d["confidence"] }}</td>
                <td>{{ d["quantity"] or "-" }}</td>
                <td>{{ d["reasoning"][:80] }}{{ "..." if d["reasoning"]|length > 80 else "" }}</td>
                <td>
                    {% if d["vetoed"] %}
                    <span class="badge badge-vetoed">vetoed</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div id="dec-pagination" style="display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom:24px; font-size:0.85rem;">
        {% if page > 1 %}
        <a href="#" onclick="loadDecisions({{ page - 1 }});return false" style="color:#58a6ff; text-decoration:none;">‚Üê Prev</a>
        {% else %}
        <span style="color:#484f58;">‚Üê Prev</span>
        {% endif %}
        <span style="color:#8b949e;">Page {{ page }} of {{ total_pages }} ({{ total_decisions }} total)</span>
        {% if page < total_pages %}
        <a href="#" onclick="loadDecisions({{ page + 1 }});return false" style="color:#58a6ff; text-decoration:none;">Next ‚Üí</a>
        {% else %}
        <span style="color:#484f58;">Next ‚Üí</span>
        {% endif %}
    </div>
    {% else %}
    <div class="empty">No decisions yet ‚Äî run a cycle first</div>
    {% endif %}
    </div>

    {% if executions %}
    <h2 style="display:flex; align-items:center; justify-content:space-between;">
        Recent Executions
        <span style="font-size:0.75rem; font-weight:400; color:#8b949e; display:flex; align-items:center; gap:10px;">
            <input id="exec-symbol-filter" type="text" placeholder="Filter symbol‚Ä¶" autocomplete="off"
                   style="background:#161b22;color:#c9d1d9;border:1px solid #30363d;border-radius:4px;padding:2px 8px;font-size:0.75rem;width:110px;">
            Show
            <select id="exec-per-page" autocomplete="off" style="background:#161b22;color:#c9d1d9;border:1px solid #30363d;border-radius:4px;padding:2px 6px;font-size:0.75rem;">
                {% for n in [5, 10, 25, 50] %}
                <option value="{{ n }}" {{ 'selected' if exec_per_page == n else '' }}>{{ n }}</option>
                {% endfor %}
            </select>
            per page
        </span>
    </h2>
    <div id="executions-container">
    <table>
        <thead>
            <tr>
                <th>Time</th>
                <th>Symbol</th>
                <th>Side</th>
                <th>Qty</th>
                <th>Amount</th>
                <th>Type</th>
                <th>Status</th>
                <th>Order ID</th>
            </tr>
        </thead>
        <tbody id="executions-body">
            {% for e in executions %}
            <tr>
                <td class="timestamp">{{ e["timestamp"][:16].replace("T", " ") }}</td>
                <td><strong class="symbol-link" onclick="showChart('{{ e.symbol }}')">{{ e["symbol"] }}</strong></td>
                <td>
                    <span class="badge badge-{{ e['side'] }}">{{ e["side"] }}</span>
                </td>
                <td>{{ e["quantity"] }}</td>
                <td>
                    {% if e.txn_amount %}
                    {% if e.status == 'expired' %}
                    <span style="text-decoration: line-through; color: #8b949e;">
                        ${{ "{:,.2f}".format(e.txn_amount) }}
                    </span>
                    {% elif e.side == 'sell' %}
                    <span style="color: #f85149; font-weight: 600;">
                        -${{ "{:,.2f}".format(e.txn_amount) }}{% if e.txn_estimated %} ~{% endif %}
                    </span>
                    {% else %}
                    <span>${{ "{:,.2f}".format(e.txn_amount) }}{% if e.txn_estimated %} <span class="timestamp">~est</span>{% endif %}</span>
                    {% endif %}
                    {% else %}
                    <span class="timestamp">‚Äî</span>
                    {% endif %}
                </td>
                <td>{{ e["order_type"] }}</td>
                <td>{{ e["status"] }}</td>
                <td class="timestamp">{{ e["order_id"][:8] }}...</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div id="exec-pagination" style="display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom:24px; font-size:0.85rem;">
        {% if exec_page > 1 %}
        <a href="#" onclick="loadExecutions({{ exec_page - 1 }});return false" style="color:#58a6ff; text-decoration:none;">‚Üê Prev</a>
        {% else %}
        <span style="color:#484f58;">‚Üê Prev</span>
        {% endif %}
        <span style="color:#8b949e;">Page {{ exec_page }} of {{ exec_total_pages }} ({{ total_executions }} total)</span>
        {% if exec_page < exec_total_pages %}
        <a href="#" onclick="loadExecutions({{ exec_page + 1 }});return false" style="color:#58a6ff; text-decoration:none;">Next ‚Üí</a>
        {% else %}
        <span style="color:#484f58;">Next ‚Üí</span>
        {% endif %}
    </div>
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
    <script>
        function _createEquityChart(labels, equityData, cryptoData) {
            const ctx = document.getElementById('equityChart').getContext('2d');
            window._equityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Equities',
                            data: equityData,
                            borderColor: '#58a6ff',
                            backgroundColor: 'rgba(88, 166, 255, 0.15)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 2,
                            order: 2,
                        },
                        {
                            label: 'Crypto',
                            data: cryptoData,
                            borderColor: '#d2a8ff',
                            backgroundColor: 'rgba(210, 168, 255, 0.15)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 2,
                            order: 1,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#8b949e', boxWidth: 12, padding: 12 }
                        },
                        tooltip: {
                            callbacks: {
                                footer: (items) => {
                                    const total = items.reduce((s, i) => s + i.parsed.y, 0);
                                    return 'Total: $' + total.toLocaleString(undefined, {minimumFractionDigits: 2});
                                }
                            }
                        }
                    },
                    scales: {
                        x: { stacked: true, ticks: { color: '#8b949e', maxTicksLimit: 10 }, grid: { color: '#21262d' } },
                        y: { stacked: true, ticks: { color: '#8b949e', callback: v => '$' + v.toLocaleString() }, grid: { color: '#21262d' } }
                    }
                }
            });
        }
        {% if equity_history|length > 1 %}
        _createEquityChart(
            [{% for e in equity_history %}"{{ e['timestamp'][:16].replace('T', ' ') }}"{{ "," if not loop.last }}{% endfor %}],
            [{% for e in equity_history %}{{ e['equity_mv'] }}{{ "," if not loop.last }}{% endfor %}],
            [{% for e in equity_history %}{{ e['crypto_mv'] }}{{ "," if not loop.last }}{% endfor %}]
        );
        {% else %}
        window._equityChart = null;
        {% endif %}
    </script>
    <script>
        async function forceCycle() {
            if (!confirm('‚ö†Ô∏è This will run a full trading cycle immediately and may execute real trades. Continue?')) return;
            const btn = document.getElementById('force-cycle-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Running‚Ä¶';
            try { await fetch('/api/force-cycle', {method: 'POST'}); } catch(e) {}
        }

        // Single WebSocket for all live updates
        (function() {
            const fmt = (n) => (n >= 0 ? '+' : '') + n.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            const money = (n) => '$' + n.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            const nextAnalysis = document.getElementById('next-analysis');
            let countdownTarget = -1;
            let pendingReload = false;
            const _pageLoadedAt = Date.now();

            function fmtTime(s) {
                if (s <= 0) return '';
                const m = Math.floor(s / 60);
                const sec = s % 60;
                return (m > 0 ? m + 'm ' : '') + sec + 's';
            }

            // Countdown tick (runs every second, driven by WS-supplied target)
            setInterval(() => {
                if (countdownTarget > 0) {
                    nextAnalysis.textContent = '‚è± Next analysis in ' + fmtTime(countdownTarget);
                    countdownTarget--;
                } else if (countdownTarget === 0) {
                    nextAnalysis.textContent = '‚è± Analyzing‚Ä¶';
                    countdownTarget = -1;
                }
            }, 1000);

            function connect() {
                const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
                const ws = new WebSocket(proto + '//' + location.host + '/ws');

                ws.onmessage = (event) => {
                    const msg = JSON.parse(event.data);

                    if (msg.type === 'pl') {
                        const eq = document.getElementById('live-equity');
                        const cash = document.getElementById('live-cash');
                        const bp = document.getElementById('live-buying-power');
                        const pl = document.getElementById('live-daily-pl');
                        const eqPl = document.getElementById('live-equity-pl');
                        const crPl = document.getElementById('live-crypto-pl');
                        if (eq) eq.textContent = money(msg.equity);
                        if (cash) cash.textContent = money(msg.cash);
                        if (bp) bp.textContent = money(msg.buying_power);
                        if (pl) {
                            pl.textContent = '$' + fmt(msg.daily_pl);
                            pl.className = 'value ' + (msg.daily_pl >= 0 ? 'positive' : 'negative');
                        }
                        if (eqPl && msg.equity_pl !== undefined) {
                            eqPl.textContent = '$' + fmt(msg.equity_pl);
                            eqPl.className = 'value ' + (msg.equity_pl >= 0 ? 'positive' : 'negative');
                        }
                        if (crPl && msg.crypto_pl !== undefined) {
                            crPl.textContent = '$' + fmt(msg.crypto_pl);
                            crPl.className = 'value ' + (msg.crypto_pl >= 0 ? 'positive' : 'negative');
                        }
                        // Append to chart when equity changes
                        if (msg.equity > 0) {
                            const eqMv = msg.equity_mv || 0;
                            const crMv = msg.crypto_mv || 0;
                            if (!window._equityChart) {
                                const wrapper = document.getElementById('equity-chart-wrapper');
                                if (wrapper) wrapper.style.display = '';
                                const now = new Date();
                                const label = now.toISOString().slice(0, 16).replace('T', ' ');
                                _createEquityChart([label], [eqMv], [crMv]);
                            } else {
                                const lastEq = window._equityChart.data.datasets[0].data.slice(-1)[0] || 0;
                                const lastCr = window._equityChart.data.datasets[1].data.slice(-1)[0] || 0;
                                if (Math.abs(eqMv - lastEq) > 0.01 || Math.abs(crMv - lastCr) > 0.01) {
                                    const now = new Date();
                                    const label = now.toISOString().slice(0, 16).replace('T', ' ');
                                    window._equityChart.data.labels.push(label);
                                    window._equityChart.data.datasets[0].data.push(eqMv);
                                    window._equityChart.data.datasets[1].data.push(crMv);
                                    window._equityChart.update('none');
                                }
                            }
                        }
                    }

                    if (msg.type === 'positions') {
                        const eqBody = document.getElementById('equity-positions-body');
                        const crBody = document.getElementById('crypto-positions-body');
                        const fmtQty = (n) => parseFloat(parseFloat(n).toFixed(4)).toLocaleString();
                        const renderRow = (p) => {
                            const plClass = p.unrealized_pl >= 0 ? 'positive' : 'negative';
                            return '<tr>' +
                                '<td><strong class="symbol-link" onclick="showChart(\'' + p.symbol + '\')">' + p.symbol + '</strong></td>' +
                                '<td>' + fmtQty(p.quantity) + '</td>' +
                                '<td>$' + p.avg_entry_price.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) + '</td>' +
                                '<td>$' + p.current_price.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) + '</td>' +
                                '<td>$' + p.market_value.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) + '</td>' +
                                '<td class="' + plClass + '">$' + fmt(p.unrealized_pl) + '</td>' +
                                '<td class="' + plClass + '">' + (p.unrealized_pl_pct >= 0 ? '+' : '') + p.unrealized_pl_pct.toFixed(1) + '%</td>' +
                                '</tr>';
                        };
                        const eqPositions = msg.positions.filter(p => p.asset_class !== 'crypto');
                        const crPositions = msg.positions.filter(p => p.asset_class === 'crypto');
                        if (eqBody) eqBody.innerHTML = eqPositions.map(renderRow).join('');
                        if (crBody) crBody.innerHTML = crPositions.map(renderRow).join('');
                    }

                    if (msg.type === 'countdown') {
                        countdownTarget = msg.seconds;
                    }

                    if (msg.type === 'new_decisions') {
                        // Skip if page just loaded (server already rendered fresh data)
                        if (Date.now() - _pageLoadedAt < 3000) return;
                        // Refresh decisions and executions in-place (no full reload)
                        if (!document.getElementById('decision-modal').classList.contains('active') &&
                            !document.getElementById('chart-modal').classList.contains('active')) {
                            loadDecisions(1);
                            loadExecutions(1);
                        } else {
                            pendingReload = true;
                        }
                    }
                };

                ws.onclose = () => setTimeout(connect, 3000);
            }

            // When modal closes, check if a refresh was pending
            const origClose = window.closeModal;
            window.closeModal = function() {
                origClose();
                if (pendingReload) {
                    pendingReload = false;
                    loadDecisions(1);
                    loadExecutions(1);
                }
            };

            connect();
        })();

        // Auto-collapse header cards on scroll
        (function() {
            const header = document.getElementById('sticky-header');
            let collapsed = false;
            let ticking = false;
            window.addEventListener('scroll', () => {
                if (!ticking) {
                    requestAnimationFrame(() => {
                        const shouldCollapse = window.scrollY > 60;
                        if (shouldCollapse !== collapsed) {
                            collapsed = shouldCollapse;
                            header.classList.toggle('compact', collapsed);
                        }
                        ticking = false;
                    });
                    ticking = true;
                }
            });
        })();
    </script>

    <!-- Decision detail modal -->
    <div class="modal-overlay" id="decision-modal" onclick="if(event.target===this)closeModal()">
        <div class="modal">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <h3 id="modal-title"></h3>
            <div class="meta" id="modal-meta"></div>
            <h4 style="color:#8b949e;font-size:0.8rem;text-transform:uppercase;margin-bottom:8px;">Reasoning</h4>
            <div class="reasoning" id="modal-reasoning"></div>
            <div class="risk-notes" id="modal-risk" style="display:none">
                <strong>Risk Notes</strong>
                <div id="modal-risk-text"></div>
            </div>
        </div>
    </div>
    <script>
        const _decisions = {
            {% for d in decisions %}
            {{ d['id'] }}: {
                symbol: "{{ d['symbol'] }}",
                action: "{{ d['action'] }}",
                confidence: "{{ d['confidence'] }}",
                quantity: "{{ d['quantity'] or '-' }}",
                timestamp: "{{ d['timestamp'][:19].replace('T', ' ') }}",
                reasoning: {{ d['reasoning'] | tojson }},
                risk_notes: {{ (d['risk_notes'] or '') | tojson }},
                vetoed: {{ 'true' if d['vetoed'] else 'false' }}
            }{{ "," if not loop.last }}
            {% endfor %}
        };
        function showDecision(id) {
            const d = _decisions[id];
            if (!d) return;
            document.getElementById('modal-title').innerHTML =
                '<span class="badge badge-' + d.action + '">' + d.action + '</span> ' + d.symbol;
            document.getElementById('modal-meta').innerHTML =
                '<span>üïê ' + d.timestamp + '</span>' +
                '<span>Confidence: <strong>' + d.confidence + '</strong></span>' +
                '<span>Qty: <strong>' + d.quantity + '</strong></span>' +
                (d.vetoed ? '<span class="badge badge-vetoed">vetoed</span>' : '');
            document.getElementById('modal-reasoning').textContent = d.reasoning;
            const risk = document.getElementById('modal-risk');
            const riskText = document.getElementById('modal-risk-text');
            if (d.risk_notes) {
                riskText.textContent = d.risk_notes;
                risk.style.display = 'block';
            } else {
                risk.style.display = 'none';
            }
            document.getElementById('decision-modal').classList.add('active');
        }
        function closeModal() {
            document.getElementById('decision-modal').classList.remove('active');
        }
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
    </script>
    <!-- Symbol chart modal -->
    <div class="modal-overlay" id="chart-modal" onclick="if(event.target===this)closeChartModal()">
        <div class="modal" style="max-width:750px;">
            <button class="modal-close" onclick="closeChartModal()">&times;</button>
            <h3 id="chart-modal-title"></h3>
            <div style="height:320px; position:relative;">
                <canvas id="symbolChart"></canvas>
            </div>
            <div id="chart-loading" style="text-align:center;padding:40px;color:#8b949e;">Loading‚Ä¶</div>
        </div>
    </div>
    <script>
        let _symbolChart = null;
        async function showChart(symbol) {
            document.getElementById('chart-modal-title').textContent = symbol;
            document.getElementById('chart-modal').classList.add('active');
            document.getElementById('chart-loading').style.display = 'block';
            const canvas = document.getElementById('symbolChart');
            canvas.style.display = 'none';

            if (_symbolChart) { _symbolChart.destroy(); _symbolChart = null; }

            try {
                const r = await fetch('/api/chart/' + encodeURIComponent(symbol) + '?days=30');
                const d = await r.json();
                if (d.error || !d.bars || d.bars.length === 0) {
                    document.getElementById('chart-loading').textContent = d.error || 'No data available';
                    return;
                }
                document.getElementById('chart-loading').style.display = 'none';
                canvas.style.display = 'block';

                const labels = d.bars.map(b => b.date);
                const closes = d.bars.map(b => b.close);
                const startPrice = closes[0];
                const endPrice = closes[closes.length - 1];
                const lineColor = endPrice >= startPrice ? '#3fb950' : '#f85149';
                const fillColor = endPrice >= startPrice ? 'rgba(63,185,80,0.1)' : 'rgba(248,81,73,0.1)';

                _symbolChart = new Chart(canvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: symbol,
                            data: closes,
                            borderColor: lineColor,
                            backgroundColor: fillColor,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 2,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { ticks: { color: '#8b949e', maxTicksLimit: 8 }, grid: { color: '#21262d' } },
                            y: { ticks: { color: '#8b949e', callback: v => '$' + v.toLocaleString() }, grid: { color: '#21262d' } }
                        }
                    }
                });
            } catch(e) {
                document.getElementById('chart-loading').textContent = 'Failed to load chart';
            }
        }
        function closeChartModal() {
            document.getElementById('chart-modal').classList.remove('active');
        }
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') { closeChartModal(); closeModal(); }
        });
    </script>
    <script>
        // AJAX pagination for decisions and executions
        (function() {
            const escHtml = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
            const money = (n) => n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});

            function renderDecisionsTable(data) {
                // Update the shared _decisions object for modal lookups
                data.decisions.forEach(d => {
                    _decisions[d.id] = {
                        symbol: d.symbol, action: d.action, confidence: d.confidence,
                        quantity: d.quantity || '-',
                        timestamp: (d.timestamp || '').slice(0, 19).replace('T', ' '),
                        reasoning: d.reasoning || '',
                        risk_notes: d.risk_notes || '',
                        vetoed: !!d.vetoed
                    };
                });
                const rows = data.decisions.map(d => {
                    const ts = (d.timestamp || '').slice(0, 16).replace('T', ' ');
                    const reasoning = d.reasoning || '';
                    const short = reasoning.length > 80 ? escHtml(reasoning.slice(0, 80)) + '...' : escHtml(reasoning);
                    const vetoed = d.vetoed ? '<span class="badge badge-vetoed">vetoed</span>' : '';
                    return '<tr class="clickable" onclick="showDecision(' + d.id + ')">' +
                        '<td class="timestamp">' + escHtml(ts) + '</td>' +
                        '<td><strong class="symbol-link" onclick="event.stopPropagation();showChart(\'' + escHtml(d.symbol) + '\')">' + escHtml(d.symbol) + '</strong></td>' +
                        '<td><span class="badge badge-' + d.action + '">' + d.action + '</span></td>' +
                        '<td>' + d.confidence + '</td>' +
                        '<td>' + (d.quantity || '-') + '</td>' +
                        '<td>' + short + '</td>' +
                        '<td>' + vetoed + '</td></tr>';
                }).join('');

                const p = data.page, tp = data.total_pages, tot = data.total;
                const prev = p > 1
                    ? '<a href="#" onclick="loadDecisions(' + (p-1) + ');return false" style="color:#58a6ff;text-decoration:none;">‚Üê Prev</a>'
                    : '<span style="color:#484f58;">‚Üê Prev</span>';
                const next = p < tp
                    ? '<a href="#" onclick="loadDecisions(' + (p+1) + ');return false" style="color:#58a6ff;text-decoration:none;">Next ‚Üí</a>'
                    : '<span style="color:#484f58;">Next ‚Üí</span>';
                const pag = '<div id="dec-pagination" style="display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:24px;font-size:0.85rem;">' +
                    prev + '<span style="color:#8b949e;">Page ' + p + ' of ' + tp + ' (' + tot + ' total)</span>' + next + '</div>';

                const container = document.getElementById('decisions-container');
                if (data.decisions.length === 0) {
                    container.innerHTML = '<div class="empty">No decisions yet ‚Äî run a cycle first</div>';
                } else {
                    container.innerHTML =
                        '<table><thead><tr><th>Time</th><th>Symbol</th><th>Action</th><th>Confidence</th><th>Qty</th><th>Reasoning</th><th>Status</th></tr></thead>' +
                        '<tbody id="decisions-body">' + rows + '</tbody></table>' + pag;
                }
            }

            function renderExecutionsTable(data) {
                const rows = data.executions.map(e => {
                    const ts = (e.timestamp || '').slice(0, 16).replace('T', ' ');
                    let amtCell;
                    if (e.txn_amount) {
                        if (e.status === 'expired') {
                            amtCell = '<span style="text-decoration:line-through;color:#8b949e;">$' + money(e.txn_amount) + '</span>';
                        } else if (e.side === 'sell') {
                            amtCell = '<span style="color:#f85149;font-weight:600;">-$' + money(e.txn_amount) + (e.txn_estimated ? ' ~' : '') + '</span>';
                        } else {
                            amtCell = '<span>$' + money(e.txn_amount) + (e.txn_estimated ? ' <span class="timestamp">~est</span>' : '') + '</span>';
                        }
                    } else {
                        amtCell = '<span class="timestamp">‚Äî</span>';
                    }
                    const oid = (e.order_id || '').slice(0, 8) + '...';
                    return '<tr>' +
                        '<td class="timestamp">' + escHtml(ts) + '</td>' +
                        '<td><strong class="symbol-link" onclick="showChart(\'' + escHtml(e.symbol) + '\')">' + escHtml(e.symbol) + '</strong></td>' +
                        '<td><span class="badge badge-' + e.side + '">' + e.side + '</span></td>' +
                        '<td>' + (e.quantity || '') + '</td>' +
                        '<td>' + amtCell + '</td>' +
                        '<td>' + (e.order_type || '') + '</td>' +
                        '<td>' + (e.status || '') + '</td>' +
                        '<td class="timestamp">' + escHtml(oid) + '</td></tr>';
                }).join('');

                const p = data.page, tp = data.total_pages, tot = data.total;
                const prev = p > 1
                    ? '<a href="#" onclick="loadExecutions(' + (p-1) + ');return false" style="color:#58a6ff;text-decoration:none;">‚Üê Prev</a>'
                    : '<span style="color:#484f58;">‚Üê Prev</span>';
                const next = p < tp
                    ? '<a href="#" onclick="loadExecutions(' + (p+1) + ');return false" style="color:#58a6ff;text-decoration:none;">Next ‚Üí</a>'
                    : '<span style="color:#484f58;">Next ‚Üí</span>';
                const pag = '<div id="exec-pagination" style="display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:24px;font-size:0.85rem;">' +
                    prev + '<span style="color:#8b949e;">Page ' + p + ' of ' + tp + ' (' + tot + ' total)</span>' + next + '</div>';

                const container = document.getElementById('executions-container');
                if (container) {
                    container.innerHTML =
                        '<table><thead><tr><th>Time</th><th>Symbol</th><th>Side</th><th>Qty</th><th>Amount</th><th>Type</th><th>Status</th><th>Order ID</th></tr></thead>' +
                        '<tbody id="executions-body">' + rows + '</tbody></table>' + pag;
                }
            }

            window._decPage = {{ page }};
            window._execPage = {{ exec_page }};

            window.loadDecisions = async function(pg) {
                const pp = document.getElementById('dec-per-page').value;
                const sym = (document.getElementById('dec-symbol-filter') || {}).value || '';
                let url = '/api/decisions?page=' + pg + '&per_page=' + pp;
                if (sym.length >= 3) url += '&symbol=' + encodeURIComponent(sym);
                const r = await fetch(url);
                const data = await r.json();
                window._decPage = data.page;
                renderDecisionsTable(data);
            };

            window.loadExecutions = async function(pg) {
                const pp = document.getElementById('exec-per-page').value;
                const sym = (document.getElementById('exec-symbol-filter') || {}).value || '';
                let url = '/api/executions?page=' + pg + '&per_page=' + pp;
                if (sym.length >= 3) url += '&symbol=' + encodeURIComponent(sym);
                const r = await fetch(url);
                const data = await r.json();
                window._execPage = data.page;
                renderExecutionsTable(data);
            };

            // Debounce helper
            function debounce(fn, ms) {
                let timer;
                return function() { clearTimeout(timer); timer = setTimeout(fn, ms); };
            }

            // Symbol filter inputs (debounced, min 3 chars or empty to clear)
            const decFilter = document.getElementById('dec-symbol-filter');
            if (decFilter) {
                decFilter.addEventListener('input', debounce(() => {
                    if (decFilter.value.length >= 3 || decFilter.value.length === 0) loadDecisions(1);
                }, 300));
            }
            const execFilter = document.getElementById('exec-symbol-filter');
            if (execFilter) {
                execFilter.addEventListener('input', debounce(() => {
                    if (execFilter.value.length >= 3 || execFilter.value.length === 0) loadExecutions(1);
                }, 300));
            }

            // Per-page select handlers
            document.getElementById('dec-per-page').addEventListener('change', () => loadDecisions(1));
            const execSel = document.getElementById('exec-per-page');
            if (execSel) execSel.addEventListener('change', () => loadExecutions(1));
        })();
    </script>
</body>
</html>
